From 06b9864dae79d1d784d28b91247bc87fc2d57a9d Mon Sep 17 00:00:00 2001
From: Seungha Yang <seungha@centricular.com>
Date: Wed, 21 Feb 2024 21:46:49 +0900
Subject: [PATCH 1/2] wasapi2: Fix task memory leak

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/6169>
---
 .../gst-plugins-bad/sys/wasapi2/gstwasapi2ringbuffer.cpp    | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/subprojects/gst-plugins-bad/sys/wasapi2/gstwasapi2ringbuffer.cpp b/subprojects/gst-plugins-bad/sys/wasapi2/gstwasapi2ringbuffer.cpp
index eaaad9506ef..86addc82320 100644
--- a/subprojects/gst-plugins-bad/sys/wasapi2/gstwasapi2ringbuffer.cpp
+++ b/subprojects/gst-plugins-bad/sys/wasapi2/gstwasapi2ringbuffer.cpp
@@ -1002,6 +1002,7 @@ gst_wasapi2_ring_buffer_prepare_loopback_client (GstWasapi2RingBuffer * self)
   hr = gst_wasapi2_ring_buffer_initialize_audio_client (self, client_handle,
       mix_format, &period, 0, GST_WASAPI2_CLIENT_DEVICE_CLASS_RENDER,
       nullptr, FALSE);
+  CoTaskMemFree (mix_format);
 
   if (!gst_wasapi2_result (hr)) {
     GST_ERROR_OBJECT (self, "Failed to initialize audio client");
@@ -1146,8 +1147,6 @@ gst_wasapi2_ring_buffer_acquire (GstAudioRingBuffer * buf,
     gst_audio_ring_buffer_set_channel_positions (buf, position);
   g_free (position);
 
-  CoTaskMemFree (mix_format);
-
   if (!gst_wasapi2_result (hr)) {
     GST_ERROR_OBJECT (self, "Failed to init audio client");
     goto error;
@@ -1213,12 +1212,15 @@ gst_wasapi2_ring_buffer_acquire (GstAudioRingBuffer * buf,
   gst_audio_format_info_fill_silence (buf->spec.info.finfo,
       buf->memory, buf->size);
 
+  CoTaskMemFree (mix_format);
+
   return TRUE;
 
 error:
   GST_WASAPI2_CLEAR_COM (self->render_client);
   GST_WASAPI2_CLEAR_COM (self->capture_client);
   GST_WASAPI2_CLEAR_COM (self->volume_object);
+  CoTaskMemFree (mix_format);
 
   gst_wasapi2_ring_buffer_post_open_error (self);
 
-- 
GitLab


From 911d8402884bb559923954be912a400b293ede43 Mon Sep 17 00:00:00 2001
From: Seungha Yang <seungha@centricular.com>
Date: Wed, 21 Feb 2024 21:50:20 +0900
Subject: [PATCH 2/2] wasapi: Fix alloc/free function mismatch

... and fix leak in wasapi device provider

Fixes: https://gitlab.freedesktop.org/gstreamer/gstreamer/-/issues/3326
Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/6169>
---
 .../gst-plugins-bad/sys/wasapi/gstwasapiutil.c      | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/subprojects/gst-plugins-bad/sys/wasapi/gstwasapiutil.c b/subprojects/gst-plugins-bad/sys/wasapi/gstwasapiutil.c
index 8f935837eea..3fd15a0b00c 100644
--- a/subprojects/gst-plugins-bad/sys/wasapi/gstwasapiutil.c
+++ b/subprojects/gst-plugins-bad/sys/wasapi/gstwasapiutil.c
@@ -407,6 +407,7 @@ gst_wasapi_util_get_devices (GstMMDeviceEnumerator * self,
     GstDevice *device;
     GstStructure *props;
     GstCaps *caps;
+    gboolean parse_ret;
 
     hr = IMMDeviceCollection_Item (device_collection, ii, &item);
     if (hr != S_OK)
@@ -469,8 +470,12 @@ gst_wasapi_util_get_devices (GstMMDeviceEnumerator * self,
       goto next;
     }
 
-    if (!gst_wasapi_util_parse_waveformatex ((WAVEFORMATEXTENSIBLE *) format,
-            gst_static_caps_get (&scaps), &caps, NULL))
+    parse_ret =
+        gst_wasapi_util_parse_waveformatex ((WAVEFORMATEXTENSIBLE *) format,
+        gst_static_caps_get (&scaps), &caps, NULL);
+    CoTaskMemFree (format);
+
+    if (!parse_ret)
       goto next;
 
     /* Set some useful properties */
@@ -556,7 +561,7 @@ gst_wasapi_util_get_device_format (GstElement * self,
       return FALSE;
     }
 
-    format = malloc (var.blob.cbSize);
+    format = CoTaskMemAlloc (var.blob.cbSize);
     memcpy (format, var.blob.pBlobData, var.blob.cbSize);
 
     PropVariantClear (&var);
@@ -570,7 +575,7 @@ gst_wasapi_util_get_device_format (GstElement * self,
     goto out;
 
   GST_ERROR_OBJECT (self, "AudioEngine DeviceFormat not supported");
-  free (format);
+  CoTaskMemFree (format);
   return FALSE;
 
 out:
-- 
GitLab

